<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; connect-src 'self'; frame-ancestors 'none'; base-uri 'self'; form-action 'self'; object-src 'none'; media-src 'none';">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta http-equiv="Referrer-Policy" content="no-referrer">
    <meta http-equiv="Permissions-Policy" content="camera=(), microphone=(), geolocation=(), payment=(), usb=(), autoplay=()">
    <meta http-equiv="Strict-Transport-Security" content="max-age=63072000; includeSubDomains; preload">
    
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å - TechPortal</title>
    <link rel="stylesheet" href="/css/admin.css">
    <style>
        /* Critical path styles only */
        .loading-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0a0a0a;
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>
            <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∞–º–∏ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ</p>
        </div>

        <div class="error-message" id="errorMessage"></div>

        <div class="stats" id="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalContacts">-</div>
                <div>–í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="unreadContacts">-</div>
                <div>–ù–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="todayContacts">-</div>
                <div>–°–µ–≥–æ–¥–Ω—è</div>
            </div>
        </div>

        <!-- Telegram Section -->
        <section id="telegram-section" class="section">
            <h2>ü§ñ Telegram Bot –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h2>
            <div class="telegram-status">
                <div class="status-card">
                    <h3>–°—Ç–∞—Ç—É—Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏</h3>
                    <div id="telegram-status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
                <div class="actions">
                    <button onclick="testTelegram()" class="btn btn-primary">–¢–µ—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</button>
                    <button onclick="sendTelegramStats()" class="btn btn-secondary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
                </div>
            </div>
        </section>

        <!-- CRM Section -->
        <section id="crm-section" class="section">
            <h2>üìä CRM –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏</h2>
            <div class="crm-status">
                <div class="status-card">
                    <h3>–°—Ç–∞—Ç—É—Å CRM —Å–∏—Å—Ç–µ–º</h3>
                    <div id="crm-status">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ CRM...</div>
                </div>
                <div class="crm-systems" id="crm-systems">
                    <!-- CRM systems will be loaded here -->
                </div>
                <div class="actions">
                    <button onclick="testCRM()" class="btn btn-primary">–¢–µ—Å—Ç CRM –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏</button>
                    <button onclick="refreshCRMStatus()" class="btn btn-secondary">–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
                </div>
            </div>
            <div class="crm-info">
                <h3>‚ÑπÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CRM</h3>
                <p>–î–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ CRM –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π —Å–º–æ—Ç—Ä–∏—Ç–µ —Ñ–∞–π–ª <code>CRM_SETUP.md</code></p>
                <p>–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: Google Sheets, Airtable, Webhook</p>
            </div>
        </section>

        <!-- Contacts Section -->
        <section id="contacts-section" class="section">
            <h2>üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã</h2>
            <div class="contacts-stats">
                <div class="stat-card">
                    <span class="stat-number" id="total-contacts">-</span>
                    <span class="stat-label">–í—Å–µ–≥–æ</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="unread-contacts">-</span>
                    <span class="stat-label">–ù–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö</span>
                </div>
            </div>
            <div class="contacts-list" id="contacts-list">
                <!-- Contacts will be loaded here -->
            </div>
            <div class="pagination" id="pagination">
                <!-- Pagination will be loaded here -->
            </div>
        </section>

        <!-- Projects Section -->
        <section id="projects-section" class="section">
            <h2>üìÅ –ü—Ä–æ–µ–∫—Ç—ã</h2>
            <div class="projects-stats" id="project-views">
                <!-- Project stats will be loaded here -->
            </div>
        </section>
    </div>

    <!-- Reply Modal -->
    <div id="reply-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeReplyModal()">&times;</span>
            <h2>–û—Ç–≤–µ—Ç–∏—Ç—å –∫–ª–∏–µ–Ω—Ç—É</h2>
            <form id="reply-form">
                <input type="hidden" id="reply-contact-id">
                <div class="form-group">
                    <label>–ö–ª–∏–µ–Ω—Ç:</label>
                    <div id="reply-contact-info"></div>
                </div>
                <div class="form-group">
                    <label for="reply-subject">–¢–µ–º–∞:</label>
                    <input type="text" id="reply-subject" required>
                </div>
                <div class="form-group">
                    <label for="reply-message">–°–æ–æ–±—â–µ–Ω–∏–µ:</label>
                    <textarea id="reply-message" rows="6" required></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    <button type="button" class="btn btn-secondary" onclick="closeReplyModal()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let contacts = [];
        let csrfToken = '';
        let currentPage = 1;
        let totalPages = 1;

        // Security constants
        const SECURITY_CONFIG = {
            maxRetries: 3,
            requestTimeout: 10000,
            tokenCheckInterval: 30000,
            maxMessageLength: 5000,
            maxNameLength: 100,
            maxEmailLength: 254
        };

        // Initialize CSRF token
        async function initCSRF() {
            try {
                const response = await fetch('/api/csrf-token');
                const data = await response.json();
                if (data.csrfToken) {
                    csrfToken = data.csrfToken;
                }
            } catch (error) {
                console.warn('CSRF token fetch failed:', error);
            }
        }

        // Input sanitization
        function sanitizeText(text) {
            if (typeof text !== 'string') return '';
            return text.replace(/[<>&"']/g, function(match) {
                const escapeMap = {
                    '<': '&lt;',
                    '>': '&gt;',
                    '&': '&amp;',
                    '"': '&quot;',
                    "'": '&#x27;'
                };
                return escapeMap[match];
            });
        }

        // Validate contact data
        function validateContact(contact) {
            if (!contact || typeof contact !== 'object') return false;
            
            const name = contact.name || '';
            const email = contact.email || '';
            const message = contact.message || '';
            
            if (name.length > SECURITY_CONFIG.maxNameLength) return false;
            if (email.length > SECURITY_CONFIG.maxEmailLength) return false;
            if (message.length > SECURITY_CONFIG.maxMessageLength) return false;
            
            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (email && !emailRegex.test(email)) return false;
            
            return true;
        }

        // Check authorization on page load
        function checkAuth() {
            try {
                const tokenStr = sessionStorage.getItem('adminToken');
                if (!tokenStr) {
                    redirectToLogin();
                    return false;
                }
                
                const tokenData = JSON.parse(tokenStr);
                if (!tokenData.token || tokenData.expires < Date.now()) {
                    sessionStorage.removeItem('adminToken');
                    redirectToLogin();
                    return false;
                }
                
                return tokenData.token;
            } catch (error) {
                sessionStorage.removeItem('adminToken');
                redirectToLogin();
                return false;
            }
        }

        // Get auth headers with CSRF protection
        function getAuthHeaders() {
            const token = checkAuth();
            if (!token) return {};
            
            const headers = {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            };
            
            if (csrfToken) {
                headers['X-CSRF-Token'] = csrfToken;
            }
            
            return headers;
        }
        
        // Secure redirect to login
        function redirectToLogin() {
            window.location.replace('/login.html');
        }

        // Logout function
        function logout() {
            sessionStorage.removeItem('adminToken');
            sessionStorage.clear();
            window.location.replace('/login.html');
        }

        // Telegram functions
        async function checkTelegramStatus() {
            const token = checkAuth();
            if (!token) return;
            
            try {
                const response = await fetch('/api/admin/telegram/status', {
                    headers: getAuthHeaders()
                });

                if (response.status === 401) {
                    logout();
                    return;
                }

                const data = await response.json();
                
                if (data.success) {
                    const telegram = data.telegram;
                    
                    // Update status indicators
                    document.getElementById('telegram-status').textContent = telegram.enabled ? '‚úÖ –ê–∫—Ç–∏–≤–µ–Ω' : '‚ùå –û—Ç–∫–ª—é—á–µ–Ω';
                    
                    showTelegramResult(telegram.enabled ? 'Telegram Bot –∞–∫—Ç–∏–≤–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ' : 'Telegram Bot –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω', 'success');
                } else {
                    showTelegramResult('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ Telegram', 'error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                showTelegramResult('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É', 'error');
            }
        }

        async function sendTestMessage() {
            const token = checkAuth();
            if (!token) return;
            
            try {
                const response = await fetch('/api/admin/telegram/test', {
                    method: 'POST',
                    headers: getAuthHeaders()
                });

                if (response.status === 401) {
                    logout();
                    return;
                }

                const data = await response.json();
                
                if (data.success) {
                    showTelegramResult('–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram!', 'success');
                } else {
                    showTelegramResult(data.message || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è', 'error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                showTelegramResult('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É', 'error');
            }
        }

        async function sendTelegramStats() {
            const token = checkAuth();
            if (!token) return;
            
            try {
                const response = await fetch('/api/admin/telegram/stats', {
                    method: 'POST',
                    headers: getAuthHeaders()
                });

                if (response.status === 401) {
                    logout();
                    return;
                }

                const data = await response.json();
                
                if (data.success) {
                    showTelegramResult('–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ Telegram!', 'success');
                } else {
                    showTelegramResult(data.message || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏', 'error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                showTelegramResult('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É', 'error');
            }
        }

        function showTelegramResult(message, type) {
            const resultEl = document.getElementById('telegram-status');
            resultEl.textContent = sanitizeText(message);
            
            if (type === 'success') {
                resultEl.style.color = '#4CAF50';
            } else {
                resultEl.style.color = '#f44336';
            }
        }

        // Load CRM status
        async function loadCRMStatus() {
            const token = checkAuth();
            if (!token) return;
            
            try {
                const response = await fetch('/api/admin/crm/status', {
                    headers: getAuthHeaders()
                });
                
                if (response.status === 401) {
                    logout();
                    return;
                }
                
                if (!response.ok) throw new Error('Failed to load CRM status');
                
                const data = await response.json();
                
                // Update status summary
                const statusDiv = document.getElementById('crm-status');
                const summary = data.summary;
                statusDiv.innerHTML = `
                    <div class="status-indicator ${summary.status}">
                        ${summary.status === 'active' ? '‚úÖ' : '‚ùå'} 
                        ${summary.activeSystems}/${summary.totalSystems} —Å–∏—Å—Ç–µ–º –∞–∫—Ç–∏–≤–Ω–æ
                    </div>
                `;
                
                // Update individual systems
                const systemsDiv = document.getElementById('crm-systems');
                let systemsHtml = '';
                
                Object.entries(data.crm).forEach(([key, system]) => {
                    systemsHtml += `
                        <div class="crm-system ${system.enabled ? 'enabled' : 'disabled'}">
                            <span class="system-name">${system.name}</span>
                            <span class="system-status">
                                ${system.enabled ? '‚úÖ –ê–∫—Ç–∏–≤–Ω–∞' : (system.configured ? '‚ö†Ô∏è –ù–∞—Å—Ç—Ä–æ–µ–Ω–∞, –Ω–æ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞' : '‚ùå –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞')}
                            </span>
                        </div>
                    `;
                });
                
                systemsDiv.innerHTML = systemsHtml;
                
            } catch (error) {
                console.error('Error loading CRM status:', error);
                document.getElementById('crm-status').innerHTML = '‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ CRM';
            }
        }

        // Test CRM integration
        async function testCRM() {
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ...';
            button.disabled = true;
            
            try {
                const response = await fetch('/api/admin/crm/test', {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast(data.message, 'success');
                    
                    // Show detailed results
                    if (data.results && data.results.length > 0) {
                        let resultsText = '–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:\n';
                        data.results.forEach(result => {
                            resultsText += `${result.system}: ${result.status === 'success' ? '‚úÖ' : '‚ùå'}\n`;
                            if (result.error) {
                                resultsText += `  –û—à–∏–±–∫–∞: ${result.error}\n`;
                            }
                        });
                        console.log(resultsText);
                    }
                } else {
                    showToast(data.message || '–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è CRM', 'error');
                }
            } catch (error) {
                console.error('CRM test error:', error);
                showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ CRM', 'error');
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        // Refresh CRM status
        async function refreshCRMStatus() {
            await loadCRMStatus();
            showToast('–°—Ç–∞—Ç—É—Å CRM –æ–±–Ω–æ–≤–ª—ë–Ω', 'success');
        }

        // Show error message
        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = sanitizeText(message);
            errorEl.style.display = 'block';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                errorEl.style.display = 'none';
            }, 5000);
        }

        async function loadContacts() {
            const token = checkAuth();
            if (!token) return;
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), SECURITY_CONFIG.requestTimeout);
                
                const response = await fetch('/api/admin/contacts', {
                    headers: getAuthHeaders(),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);

                if (response.status === 401) {
                    logout();
                    return;
                }

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();

                if (data.success && Array.isArray(data.contacts)) {
                    // Validate all contacts
                    contacts = data.contacts.filter(validateContact);
                    updateStats();
                    renderContacts();
                } else {
                    showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫');
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    showError('–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è');
                } else {
                console.error('–û—à–∏–±–∫–∞:', error);
                    showError('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
                }
            }
        }

        function updateStats() {
            const total = contacts.length;
            const unread = contacts.filter(c => !c.isRead).length;
            const today = contacts.filter(c => {
                const today = new Date().toDateString();
                const contactDate = new Date(c.createdAt).toDateString();
                return today === contactDate;
            }).length;

            // Safely update text content
            document.getElementById('total-contacts').textContent = String(total);
            document.getElementById('unread-contacts').textContent = String(unread);
        }

        function renderContacts() {
            const container = document.getElementById('contacts-list');

            if (contacts.length === 0) {
                container.textContent = '–ó–∞—è–≤–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç';
                container.className = 'empty';
                return;
            }

            // Clear container safely
            container.innerHTML = '';
            container.className = '';
            
            contacts.forEach(contact => {
                const contactDiv = document.createElement('div');
                contactDiv.className = 'contact-item' + (!contact.isRead ? ' unread' : '');
                contactDiv.setAttribute('data-contact-id', contact._id);
                
                // Header
                const headerDiv = document.createElement('div');
                headerDiv.className = 'contact-header';
                
                const infoDiv = document.createElement('div');
                infoDiv.className = 'contact-info';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'contact-name';
                nameDiv.textContent = sanitizeText(contact.name || '–ë–µ–∑ –∏–º–µ–Ω–∏');
                
                const emailDiv = document.createElement('div');
                emailDiv.className = 'contact-email';
                emailDiv.textContent = sanitizeText(contact.email || '–ë–µ–∑ email');
                
                const dateDiv = document.createElement('div');
                dateDiv.className = 'contact-date';
                dateDiv.textContent = formatDate(contact.createdAt);
                
                infoDiv.appendChild(nameDiv);
                infoDiv.appendChild(emailDiv);
                headerDiv.appendChild(infoDiv);
                headerDiv.appendChild(dateDiv);
                
                // Message
                const messageDiv = document.createElement('div');
                messageDiv.className = 'contact-message';
                messageDiv.textContent = sanitizeText(contact.message || '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è');
                
                // Actions
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'contact-actions';
                
                if (!contact.isRead) {
                    const readBtn = document.createElement('button');
                    readBtn.className = 'btn btn-read';
                    readBtn.textContent = '–û—Ç–º–µ—Ç–∏—Ç—å –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º';
                    readBtn.setAttribute('data-action', 'read');
                    readBtn.setAttribute('data-contact-id', contact._id);
                    actionsDiv.appendChild(readBtn);
                } else {
                    const readSpan = document.createElement('span');
                    readSpan.style.cssText = 'color: #4CAF50; font-size: 0.85rem;';
                    readSpan.textContent = '‚úì –ü—Ä–æ—á–∏—Ç–∞–Ω–æ';
                    actionsDiv.appendChild(readSpan);
                }
                
                const replyBtn = document.createElement('button');
                replyBtn.className = 'btn';
                replyBtn.style.cssText = 'background: #2196F3; color: white;';
                replyBtn.textContent = '–û—Ç–≤–µ—Ç–∏—Ç—å';
                replyBtn.setAttribute('data-action', 'reply');
                replyBtn.setAttribute('data-contact-id', contact._id);
                actionsDiv.appendChild(replyBtn);
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-delete';
                deleteBtn.textContent = '–£–¥–∞–ª–∏—Ç—å';
                deleteBtn.setAttribute('data-action', 'delete');
                deleteBtn.setAttribute('data-contact-id', contact._id);
                actionsDiv.appendChild(deleteBtn);
                
                contactDiv.appendChild(headerDiv);
                contactDiv.appendChild(messageDiv);
                contactDiv.appendChild(actionsDiv);
                
                container.appendChild(contactDiv);
            });
        }

        async function markAsRead(contactId) {
            if (!contactId || typeof contactId !== 'string') return false;
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), SECURITY_CONFIG.requestTimeout);
                
                const response = await fetch('/api/admin/contacts/' + encodeURIComponent(contactId) + '/read', {
                    method: 'PATCH',
                    headers: getAuthHeaders(),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);

                if (response.ok) {
                    const contact = contacts.find(c => c._id === contactId);
                    if (contact) {
                        contact.isRead = true;
                        updateStats();
                        renderContacts();
                    }
                    return true;
                }
            } catch (error) {
                if (error.name !== 'AbortError') {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–º–µ—Ç–∫–∏ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ:', error);
                }
                showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞');
            }
            return false;
        }

        async function deleteContact(contactId) {
            if (!contactId || typeof contactId !== 'string') return false;
            
            if (!await showSecureConfirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞—è–≤–∫—É?')) {
                return false;
            }

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), SECURITY_CONFIG.requestTimeout);
                
                const response = await fetch('/api/admin/contacts/' + encodeURIComponent(contactId), {
                    method: 'DELETE',
                    headers: getAuthHeaders(),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);

                if (response.ok) {
                    contacts = contacts.filter(c => c._id !== contactId);
                    updateStats();
                    renderContacts();
                    return true;
                }
            } catch (error) {
                if (error.name !== 'AbortError') {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error);
                }
                showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞—è–≤–∫–∏');
            }
            return false;
        }

        function formatDate(dateString) {
            try {
            const date = new Date(dateString);
                if (isNaN(date.getTime())) return '–ù–µ–≤–µ—Ä–Ω–∞—è –¥–∞—Ç–∞';
                
            return date.toLocaleString('ru-RU', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            } catch (error) {
                return '–ù–µ–≤–µ—Ä–Ω–∞—è –¥–∞—Ç–∞';
            }
        }

        // Event delegation for contact actions
        document.addEventListener('click', async function(event) {
            const target = event.target;
            
            if (target.hasAttribute('data-action')) {
                event.preventDefault();
                const action = target.getAttribute('data-action');
                const contactId = target.getAttribute('data-contact-id');
                
                if (!contactId) return;
                
                if (action === 'read') {
                    target.disabled = true;
                    target.textContent = '–û–±–Ω–æ–≤–ª—è–µ–º...';
                    await markAsRead(contactId);
                } else if (action === 'reply') {
                    const contact = contacts.find(c => c._id === contactId);
                    if (contact) {
                        showReplyModal(contact);
                    }
                } else if (action === 'delete') {
                    target.disabled = true;
                    const originalText = target.textContent;
                    target.textContent = '–£–¥–∞–ª—è–µ–º...';
                    const success = await deleteContact(contactId);
                    if (!success) {
                        target.disabled = false;
                        target.textContent = originalText;
                    }
                }
            }
        });

        // Page visibility and activity tracking
        let isPageVisible = true;
        let lastActivity = Date.now();
        
        document.addEventListener('visibilitychange', () => {
            isPageVisible = !document.hidden;
        });
        
        document.addEventListener('mousemove', () => {
            lastActivity = Date.now();
        });
        
        document.addEventListener('keydown', () => {
            lastActivity = Date.now();
        });
        
        // Secure auto-refresh with activity checks
        function secureAutoRefresh() {
            const fiveMinutes = 5 * 60 * 1000;
            if (isPageVisible && (Date.now() - lastActivity < fiveMinutes)) {
                loadContacts();
            }
        }

        // Event listeners
        document.getElementById('refreshBtn').addEventListener('click', loadContacts);
        document.getElementById('logoutBtn').addEventListener('click', logout);

        // Secure confirm dialog
        function showSecureConfirm(message) {
            return new Promise((resolve) => {
                const existingDialog = document.querySelector('.secure-confirm-dialog');
                if (existingDialog) {
                    existingDialog.remove();
                }
                
                const overlay = document.createElement('div');
                overlay.className = 'secure-confirm-overlay';
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.7);
                    z-index: 50000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                `;
                
                const dialog = document.createElement('div');
                dialog.className = 'secure-confirm-dialog';
                dialog.style.cssText = `
                    background: #1a1a1a;
                    padding: 2rem;
                    border-radius: 15px;
                    max-width: 400px;
                    margin: 1rem;
                    text-align: center;
                    border: 1px solid #333;
                `;
                
                const messageEl = document.createElement('p');
                messageEl.textContent = sanitizeText(message);
                messageEl.style.cssText = `
                    color: white;
                    margin-bottom: 2rem;
                    font-size: 1.1rem;
                `;
                
                const buttonsContainer = document.createElement('div');
                buttonsContainer.style.cssText = `
                    display: flex;
                    gap: 1rem;
                    justify-content: center;
                `;
                
                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = '–û—Ç–º–µ–Ω–∞';
                cancelBtn.style.cssText = `
                    padding: 0.75rem 1.5rem;
                    border: 1px solid #666;
                    background: transparent;
                    color: white;
                    border-radius: 8px;
                    cursor: pointer;
                `;
                
                const confirmBtn = document.createElement('button');
                confirmBtn.textContent = '–£–¥–∞–ª–∏—Ç—å';
                confirmBtn.style.cssText = `
                    padding: 0.75rem 1.5rem;
                    border: none;
                    background: #f44336;
                    color: white;
                    border-radius: 8px;
                    cursor: pointer;
                `;
                
                cancelBtn.addEventListener('click', () => {
                    overlay.remove();
                    resolve(false);
                });
                
                confirmBtn.addEventListener('click', () => {
                    overlay.remove();
                    resolve(true);
                });
                
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        overlay.remove();
                        resolve(false);
                    }
                });
                
                const escapeHandler = (e) => {
                    if (e.key === 'Escape') {
                        document.removeEventListener('keydown', escapeHandler);
                        overlay.remove();
                        resolve(false);
                    }
                };
                document.addEventListener('keydown', escapeHandler);
                
                buttonsContainer.appendChild(cancelBtn);
                buttonsContainer.appendChild(confirmBtn);
                dialog.appendChild(messageEl);
                dialog.appendChild(buttonsContainer);
                overlay.appendChild(dialog);
                document.body.appendChild(overlay);
                
                cancelBtn.focus();
            });
        }

        // Initialize page
        window.addEventListener('load', async () => {
            await initCSRF();
            loadContacts();
            // Load status on page load
            setTimeout(() => {
                checkTelegramStatus();
                loadCRMStatus();
            }, 1000);
        });

        // Auto-refresh every 30 seconds with security checks
        setInterval(secureAutoRefresh, 30000);

        // Token validity check every 30 seconds
        setInterval(() => {
            if (!checkAuth()) {
                logout();
            }
        }, SECURITY_CONFIG.tokenCheckInterval);
    </script>
</body>
</html> 
</html> 